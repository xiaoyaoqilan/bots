# ==============================================================================
# 刷量交易配置文件 - Backpack BTC永续合约
# ==============================================================================
# 
# 🎯 功能说明：通过自动化交易快速刷交易量
# 
# 📋 两种交易模式：
# 
# 【限价开仓模式 order_mode: "limit"】（推荐：成本低，成交慢）
#    1. 实时监控订单簿买1/卖1价格
#    2. 检测价格稳定（N秒内不变）
#    3. 同时挂买1和卖1订单
#    4. 其中一个成交后立即取消另一个
#    5. 市价平仓当前持仓
#    6. 重复下一轮
# 
# 【市价开仓模式 order_mode: "market"】（推荐：速度快，成本高）
#    1. 等待价格稳定（N秒内不变）
#    2. 分析订单簿买1/卖1的挂单数量
#    3. 选择数量少的一方进行开仓（吃单）
#       - 如果卖1数量少 → 市价买入（开多，吃卖1）
#       - 如果买1数量少 → 市价卖出（开空，吃买1）
#    4. 立即市价平仓
#    5. 重复下一轮
# 
# ==============================================================================

volume_maker:
  # ============================================================================
  # 基础配置
  # ============================================================================
  exchange: "backpack"              # 交易所
  symbol: "BTC_USDC_PERP"          # 交易对（BTC永续合约）
  
  # ============================================================================
  # 订单参数
  # ============================================================================
  order_mode: "market"              # 订单模式：
                                    # - "limit"  : 限价开仓模式（挂买1/卖1，等待成交）
                                    # - "market" : 市价开仓模式（选择数量少的一方直接吃单）
  order_size: 0.01                # 每次下单数量（BTC）
  min_size: 0.0001                 # 最小下单数量（BTC）
  max_size: 0.01                   # 最大下单数量（BTC）
  quantity_precision: 2            # 数量精度（5位小数）
  market_order_interval_ms: 0      # 市价模式：开仓和平仓订单之间的间隔（毫秒）
                                    # - 0    : 无间隔，立即提交（最快，推荐）
                                    # - 100  : 100毫秒间隔
                                    # - 500  : 500毫秒间隔
                                    # - 1000 : 1秒间隔（较保守）
                                    # 注意：如果启用 market_wait_price_change，此参数失效
  market_wait_price_change: true   # 市价模式：是否等待价格变化后再平仓
                                    # - false : 使用固定间隔（market_order_interval_ms）
                                    # - true  : 等待订单簿价格变化后平仓（interval_ms失效）
                                    # 启用后：开仓 → 等待价格变化 → 平仓
  market_close_on_quantity_reversal: true  # 市价模式：平仓时检测订单簿数量反转（仅市价模式有效）
                                    # - false : 禁用，仅检测价格变化
                                    # - true  : 启用，检测买1/卖1数量反转时平仓
                                    # 
                                    # 功能说明：
                                    # 开仓时记录买1和卖1的数量对比关系（谁多谁少）
                                    # 开仓后持续监控订单簿，如果数量对比关系发生反转，立即平仓
                                    # 
                                    # 触发平仓条件（满足任意一个即可）：
                                    # 1. 价格变化（market_wait_price_change = true）
                                    # 2. 数量反转（market_close_on_quantity_reversal = true）
                                    # 
                                    # 示例：
                                    # 开仓时：买1数量(100) > 卖1数量(50) → 记录为"买单多"
                                    # 监控中：买1数量(40) < 卖1数量(80) → 反转了！触发平仓
                                    # 
                                    # 注意：此功能仅在 order_mode="market" 时有效
                                    #      限价模式下此选项无效
  market_price_change_count: 2      # 市价模式：价格变化多少次后触发平仓（默认1次）
                                    # - 1    : 价格变化1次就触发平仓（默认，灵敏）
                                    # - 2    : 价格变化2次才触发平仓（中等）
                                    # - 3    : 价格变化3次才触发平仓（保守）
                                    # - 5+   : 更保守的设置
                                    # 
                                    # 功能说明：
                                    # 当启用 market_wait_price_change = true 时，此配置生效
                                    # 开仓后持续监控订单簿价格，只有当价格变化累计达到设定次数时才触发平仓
                                    # 
                                    # 价格变化定义：
                                    # 买1价格或卖1价格与开仓时的价格不同即视为一次变化
                                    # 
                                    # 使用场景：
                                    # - 设置为1：快速响应市场，价格一变就平仓（适合高频刷量）
                                    # - 设置为2-3：等待价格确认，减少误触发（适合波动市场）
                                    # - 设置为5+：极度保守，等待明显的价格趋势（适合极端波动）
                                    # 
                                    # 注意：
                                    # - 此功能仅在 order_mode="market" 且 market_wait_price_change=true 时有效
                                    # - 数量反转触发不受此参数影响（反转即触发）
  market_wait_timeout: 65.0         # 市价模式：等待价格变化的最大超时时间（秒，默认30秒）
                                    # - 10   : 快速超时（适合高频刷量，避免长时间等待）
                                    # - 30   : 默认超时（平衡等待时间和响应速度）
                                    # - 60   : 较长超时（允许更多时间等待价格变化）
                                    # - 120+ : 极长超时（极度保守，适合极低波动市场）
                                    # 
                                    # 功能说明：
                                    # 当启用 market_wait_price_change = true 时，此配置生效
                                    # 如果在超时时间内价格变化次数未达到要求，则强制平仓
                                    # 
                                    # 触发平仓的条件（满足任一即触发）：
                                    # 1. 价格变化达到 market_price_change_count 次
                                    # 2. 数量反转（如果启用 market_close_on_quantity_reversal）
                                    # 3. 等待时间超过 market_wait_timeout 秒
                                    # 
                                    # 使用场景：
                                    # - 10-20秒 : 高频刷量，快进快出
                                    # - 30-40秒 : 正常刷量，平衡等待
                                    # - 60-90秒 : 保守策略，充分等待
                                    # - 120秒+  : 极度保守，适合极低波动
                                    # 
                                    # 注意：
                                    # - 超时后强制平仓，平仓原因显示为"超时"
                                    # - 配合 market_price_change_count 使用效果更好
                                    # - 超时时间过短可能导致频繁超时平仓
                                    # - 超时时间过长可能影响刷量效率
  
  # ============================================================================
  # 成交价格获取方式（影响统计准确性）
  # ============================================================================
  fill_price_method: "websocket"    # 成交价格获取方式：
                                    # - "rest"      : REST API 查询历史订单（延迟高，需等待3秒×10次=30秒）
                                    # - "websocket" : WebSocket 实时订阅（延迟低<100ms，100%准确，推荐）
                                    # 
                                    # 对比：
                                    # REST API 方式：
                                    #   - 延迟：10-30秒（等待订单写入历史）
                                    #   - 准确率：~95%（偶尔超时降级到估算）
                                    #   - 适用：对统计要求不高的场景
                                    # 
                                    # WebSocket 方式（推荐）：
                                    #   - 延迟：<100ms（实时推送）
                                    #   - 准确率：100%（直接从订单更新获取）
                                    #   - 适用：需要精确统计的场景
  
  # ============================================================================
  # 订单簿获取方式（影响价格稳定检测）
  # ============================================================================
  orderbook_method: "rest"     # 订单簿获取方式：
                                    # - "rest"      : REST API 轮询（0.1秒/次，API调用量高）
                                    # - "websocket" : WebSocket 实时订阅（实时推送，推荐）
                                    # 
                                    # 对比：
                                    # REST API 方式：
                                    #   - 延迟：100-200ms
                                    #   - API调用：0.1秒/次（5秒内调用50次）
                                    #   - 适用：简单场景，不需要实时性
                                    # 
                                    # WebSocket 方式（推荐）：
                                    #   - 延迟：<50ms（实时推送）
                                    #   - API调用：0次（订阅后自动推送）
                                    #   - 适用：需要实时订单簿、反转检测等高精度场景
  
  # ============================================================================
  # 价格稳定检测参数（两种模式都生效）
  # ============================================================================
  stability_check_duration: 3      # 价格稳定检测时长（秒）
                                    # - 限价模式：确保挂单价格有效
                                    # - 市价模式：确保市场稳定再开仓
  price_tolerance: 0.0             # 价格波动容忍度（0表示完全不变）
  check_interval: 0.1              # 价格检查间隔（秒）
  
  # 买卖单数量对比反转检测（高级功能）
  check_orderbook_reversal: false  # 是否检测买卖单数量对比反转
                                    # - false : 仅检测价格稳定（默认）
                                    # - true  : 同时检测价格和买卖单数量对比
                                    # 
                                    # 启用后的行为：
                                    # 1. 记录初始状态：买单多 还是 卖单多
                                    # 2. 检测期间：买卖单数量对比不能发生反转
                                    # 3. 发生反转：重新计时（类似价格变化）
                                    # 
                                    # 示例场景：
                                    # - 初始：卖单(100) > 买单(80) → 卖单多
                                    # - 5秒内：卖单始终 > 买单 → ✅ 稳定，可开仓
                                    # - 5秒内：卖单(70) < 买单(90) → ❌ 反转，重新计时
                                    # 
                                    # 适用场景：
                                    # - 追求更严格的市场稳定性
                                    # - 避免在订单簿剧烈波动时开仓
                                    # - 提高开仓成功率
  
  # 买卖单数量比例检查（最后防线）
  orderbook_quantity_ratio: 300      # 买卖单数量比例阈值（百分比）
                                    # - 0     : 不启用此功能（默认）
                                    # - 100   : 无限制（任何比例都可开仓）
                                    # - 150   : 要求1.5倍差距
                                    # - 200   : 要求2倍差距（推荐）
                                    # - 300   : 要求3倍差距
                                    # 
                                    # 检查时机：
                                    # 在价格稳定完成（5秒）后，准备开仓前的那一刻
                                    # 
                                    # 计算方式：
                                    # 比例 = max(买1数量, 卖1数量) / min(买1数量, 卖1数量) × 100
                                    # 
                                    # 示例场景（阈值200%）：
                                    # - 买1=100, 卖1=50  → 100/50=200%  → ✅ 满足，开仓
                                    # - 买1=100, 卖1=80  → 100/80=125%  → ❌ 不满足，重新计时
                                    # - 买1=50,  卖1=150 → 150/50=300%  → ✅ 满足，开仓
                                    # 
                                    # 与反转检测的关系：
                                    # - 独立功能，可单独启用
                                    # - 反转检测=在过程中监控
                                    # - 比例检查=在结果时验证
                                    # 
                                    # 适用场景：
                                    # - 确保订单簿有明显偏向（买压或卖压）
                                    # - 避免在盘整时开仓
                                    # - 提高开仓成功率和盈利概率
  orderbook_min_quantity: 1.5      # 订单簿最小数量要求（仅市价模式有效）
                                    # - 0     : 不启用此功能（默认）
                                    # - 0.5   : 数量多的一方必须 >= 0.5
                                    # - 1.0   : 数量多的一方必须 >= 1.0
                                    # - 2.0   : 数量多的一方必须 >= 2.0（更严格）
                                    # 
                                    # 功能说明：
                                    # 在价格稳定和比例检查都通过后，再检查订单簿深度
                                    # 检查数量多的那一方（买单多→检查买1，卖单多→检查卖1）
                                    # 如果数量不足，不重置倒计时，继续等待数量满足
                                    # 
                                    # 与其他条件的关系：
                                    # 1. 价格稳定（stability_check_duration）    → 不满足：重置倒计时
                                    # 2. 数量比例（orderbook_quantity_ratio）    → 不满足：重置倒计时
                                    # 3. 最小数量（orderbook_min_quantity）【新】 → 不满足：不重置，继续等待
                                    # 
                                    # 开仓必须同时满足以上3个条件
                                    # 
                                    # 示例场景（阈值1.0）：
                                    # 场景1：T=0秒开始，T=5秒 价格稳定✅ 比例✅ 买1数量1.5✅ → 开仓
                                    # 场景2：T=0秒开始，T=5秒 价格稳定✅ 比例✅ 买1数量0.5❌ → 不重置，继续等
                                    #        T=7秒 价格稳定✅ 比例✅ 买1数量1.2✅ → 开仓
                                    # 场景3：T=0秒开始，T=5秒 价格稳定✅ 比例✅ 买1数量0.5❌ → 不重置
                                    #        T=6秒 价格变化❌ → 重置倒计时，回到T=0
                                    # 
                                    # 适用场景：
                                    # - 确保有足够的订单簿深度才开仓
                                    # - 避免在订单簿过薄时开仓（滑点风险）
                                    # - 提高开仓质量和成交稳定性
                                    # 
                                    # 注意：
                                    # - 此功能仅在 order_mode="market" 时有效
                                    # - 限价模式下此选项无效
                                    # - 数量不足时会持续等待，不会重置倒计时
                                    # - 配合其他条件使用，形成三重防护
  
  # ============================================================================
  # 风控参数
  # ============================================================================
  max_cycles: 1720                 # 最大交易轮次（限制总交易量）
  max_position: 0.01                # 最大持仓限制（BTC）
  max_slippage: 0.001              # 最大滑点容忍度（0.1%）
  order_timeout: 60                # 订单超时时间（秒）
  max_consecutive_fails: 5         # 最大连续失败次数后触发等待
  consecutive_fail_wait_minutes: 15  # 连续失败达到阈值后等待时间（分钟）
                                   # 0表示达到失败次数后直接停止
                                   # 15表示等待15分钟后重置失败计数并继续交易
  min_balance: 100                 # 最小余额阈值（USDC），低于此值停止交易
                                    # - 注释掉或设置为 null 则不检查余额
                                    # - 建议设置为：保证金需求 + 安全缓冲
                                    # - 例如：每次开仓约111 USDC，设置200安全
  
  # ============================================================================
  # 执行控制
  # ============================================================================
  cycle_interval: 0                # 每轮完成后等待时间（秒，0表示立即开始）
  emergency_stop: true             # 紧急停止开关
  auto_restart_on_error: false     # 错误后自动重启
  
  # ============================================================================
  # 日志配置
  # ============================================================================
  logging:
    enabled: true
    log_to_file: true              # 日志写入文件
    log_to_console: false          # 不输出到控制台（保护终端UI）
    log_level: "INFO"              # 日志级别
    log_dir: "logs"                # 日志目录
    log_file: "volume_maker.log"   # 日志文件名
    
    # 日志轮转配置
    rotation:
      max_bytes: 2097152           # 单个日志文件最大大小（2MB，降低以便更频繁轮转）
      backup_count: 10             # 最多保留10个日志文件（增加备份数量）
      encoding: "utf-8"
  
  # ============================================================================
  # 统计配置
  # ============================================================================
  statistics:
    enabled: true
    track_total_volume: true       # 跟踪总交易量
    track_success_rate: true       # 跟踪成功率
    track_pnl: true                # 跟踪盈亏
    save_interval: 60              # 统计数据保存间隔（秒）
  
  # ============================================================================
  # 终端UI配置
  # ============================================================================
  ui:
    enabled: true
    refresh_rate: 1                # 刷新频率（次/秒）
    show_orderbook: true           # 显示订单簿
    show_recent_trades: true       # 显示最近成交
    recent_trades_limit: 10        # 显示最近N笔成交
  
  # ============================================================================
  # 高级配置
  # ============================================================================
  advanced:
    use_post_only: false           # 是否只使用Post-Only订单
    cancel_on_timeout: true        # 超时后取消订单
    retry_on_rate_limit: true      # 触发限频后重试
    rate_limit_cooldown: 1         # 限频冷却时间（秒）

