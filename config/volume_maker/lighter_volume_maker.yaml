# ==============================================================================
# Lighter市价刷量配置文件（支持Backpack/Hyperliquid信号源）
# ==============================================================================
# 
# 🎯 功能说明：在Lighter上执行市价刷量（基于Backpack或Hyperliquid价格信号）
# 
# 📋 架构说明：
#    【双交易所架构】
#    ├── 信号源：Backpack（REST API） 或 Hyperliquid（WebSocket）
#    │   └── 监控价格稳定
#    │   └── 检测订单簿条件
#    │   └── 所有判断在信号源完成
#    └── 执行端：Lighter
#        └── 执行市价开仓
#        └── 执行市价平仓
# 
# 📋 交易流程（仅市价模式）：
#    1. 监控Backpack订单簿 → 等待价格稳定（N秒内不变）
#    2. 检查Backpack订单簿条件（数量比例、最小数量等）
#    3. 决定交易方向（买入或卖出）
#    4. 在Lighter执行市价开仓
#    5. 等待一小段时间
#    6. 在Lighter执行市价平仓
#    7. 重复下一轮
# 
# 🔥 核心特性：
#    - 完全独立运行，不影响原Backpack刷量脚本
#    - 复用原脚本的所有判断逻辑
#    - 简单高效的市价交易
#    - WebSocket + client_id 追踪订单成交
# 
# 🚀 性能优化（2025-11-03）：
#    优化前：每个循环 4-5次 REST API 调用
#    优化后：每个循环 1-2次 REST API 调用
#    节省比例：60-75% REST API 开销
#    
#    优化策略：
#    - ✅ 使用 client_id 精确追踪订单
#    - ✅ WebSocket 优先获取成交信息
#    - ✅ 跳过开仓前持仓检查（假设为空）
#    - ✅ WebSocket正常时跳过平仓后验证
#    - ✅ 仅超时时使用 REST 验证兜底
#    - ✅ 余额检查频率优化（每10轮一次）
# 
# ==============================================================================

volume_maker:
  # ============================================================================
  # 基础配置
  # ============================================================================
  exchange: "lighter"              # 执行交易所（Lighter）
  symbol: "BTC"                    # Lighter交易对符号
  
  # 🔥 双交易所符号配置（新增）
  signal_exchange: "hyperliquid"   # 信号源交易所：backpack（默认）或 hyperliquid
                                   # - backpack   : 使用 REST API 获取订单簿（传统方式）
                                   # - hyperliquid: 使用 WebSocket 获取订单簿（低延迟，推荐）✅ 当前使用
  
  signal_symbol: "BTC/USDC:USDC"   # 信号源符号（根据交易所格式配置）
                                   # - backpack   : BTC_USDC_PERP
                                   # - hyperliquid: BTC/USDC:USDC（永续合约标准格式）✅ 当前使用
  
  execution_symbol: "BTC"          # Lighter执行端符号
  
  # ⚠️ 注意：配置文件中同时需要配置：
  #    - config/exchanges/backpack_config.yaml （信号源）
  #    - config/exchanges/hyperliquid_config.yaml （信号源）
  #    - config/exchanges/lighter_config.yaml  （执行端）
  
  # ============================================================================
  # 订单参数
  # ============================================================================
  order_mode: "market"             # 🔥 固定为市价模式（Lighter仅支持市价）
  order_size: 0.001                # 每次下单数量（BTC）
                                   # 建议：0.0002-0.001 BTC（根据资金量调整）
  min_size: 0.0001                 # 最小下单数量（BTC）
  max_size: 0.01                   # 最大下单数量（BTC）
  quantity_precision: 4            # 数量精度（4位小数）
  
  # 市价模式参数
  market_wait_price_change: true   # 市价模式：是否等待价格变化后再平仓
                                   # - false : 使用固定间隔（post_trade_delay）
                                   # - true  : 等待Backpack订单簿价格变化后平仓（推荐）
                                   # 启用后：开仓 → 监控Backpack价格变化 → 平仓
  
  market_price_change_count: 3     # 市价模式：Backpack价格变化多少次后触发平仓（默认1次）
                                   # - 1    : 价格变化1次就触发平仓（默认，灵敏）
                                   # - 2    : 价格变化2次才触发平仓（中等）
                                   # - 3    : 价格变化3次才触发平仓（保守）
                                   # 
                                   # 功能说明：
                                   # 开仓后持续监控Backpack订单簿价格
                                   # 只有当价格变化累计达到设定次数时才在Lighter平仓
                                   # 
                                   # 价格变化定义：
                                   # Backpack买1价格或卖1价格与开仓时的价格不同即视为一次变化
  
  market_close_on_quantity_reversal: true  # 市价模式：平仓时检测Backpack订单簿数量反转
                                   # - false : 禁用，仅检测价格变化
                                   # - true  : 启用，检测买1/卖1数量反转时平仓
                                   # 
                                   # 功能说明：
                                   # 开仓时记录Backpack买1和卖1的数量对比关系（谁多谁少）
                                   # 开仓后持续监控Backpack订单簿，如果数量对比关系发生反转，立即在Lighter平仓
                                   # 
                                   # 触发平仓条件（满足任意一个即可）：
                                   # 1. 价格变化达到要求次数（market_price_change_count）
                                   # 2. 数量反转（market_close_on_quantity_reversal = true）
                                   # 
                                   # 示例：
                                   # 开仓时：Backpack买1数量(100) > 卖1数量(50) → 记录为"买单多"
                                   # 监控中：Backpack买1数量(40) < 卖1数量(80) → 反转了！触发Lighter平仓
  
  market_wait_timeout: 60.0        # 市价模式：等待价格变化的最大超时时间（秒，默认30秒）
                                   # - 10   : 快速超时（适合高频刷量）
                                   # - 30   : 默认超时（推荐）
                                   # - 60   : 较长超时（允许更多时间等待价格变化）
                                   # 
                                   # 功能说明：
                                   # 如果在此时间内Backpack价格没有变化或数量没有反转
                                   # 将强制在Lighter平仓，避免长时间持仓
  
  post_trade_delay: 0              # 🔥 仅当 market_wait_price_change=false 时有效
                                   # 开仓后等待时间（秒）再平仓
                                   # - 0    : 立即平仓（最快）
                                   # - 1    : 等待1秒（推荐）
                                   # - 2-3  : 等待2-3秒（较保守）
  
  # ============================================================================
  # Lighter 链上交易配置
  # ============================================================================
  chain_confirmation_wait: 3      # 🔥 链上交易确认等待时间（秒）
                                   # Lighter是基于区块链的交易所，平仓后需要等待链上确认
                                   # - 3    : 优化模式（WebSocket正常时跳过验证）✅
                                   # - 10   : 快速模式（可能导致持仓验证失败）
                                   # - 20   : 标准模式（适合快速网络）
                                   # - 30   : 推荐模式（平衡速度和稳定性）
                                   # - 60   : 保守模式（适合网络延迟高或交易拥堵时）
                                   # 
                                   # 🔥 优化说明（2025-11-03）：
                                   # - WebSocket正常时：跳过持仓验证，减少REST API调用
                                   # - WebSocket超时时：才使用此延迟+REST验证
                                   # - 正常情况每循环节省 1-5次 REST API 调用
                                   # 
                                   # 作用：
                                   # 1. 避免频繁查询触发API限流 (429错误)
                                   # 2. 让交易所后端有足够时间更新持仓状态
                                   # 3. 确保持仓清空验证的准确性
                                   # 
                                   # 建议：
                                   # - WebSocket稳定时可设置为较小值（3-10秒）
                                   # - 如果经常出现"持仓未清空"警告，增加此值
  
  websocket_fill_timeout: 5       # 🔥 WebSocket成交确认超时时间（秒）
                                   # 等待WebSocket推送订单成交信息的最大时间
                                   # - 5    : 优化超时（适合网络良好的情况）✅
                                   # - 10   : 快速超时（可能丢失成交价）
                                   # - 15   : 推荐超时（平衡速度和准确性）
                                   # - 20   : 保守超时（确保获取成交价）
                                   # 
                                   # 🔥 优化逻辑（2025-11-03）：
                                   # 1. 使用 client_id 精确匹配订单
                                   # 2. WebSocket正常：0.5-2秒内收到成交，获取真实价格
                                   # 3. WebSocket超时：使用REST验证 + Backpack估算价格
                                   # 4. 正常情况避免所有REST API查询
                                   # 
                                   # 作用：
                                   # 1. 获取真实成交价格（而不是估算）
                                   # 2. 超时后自动降级到REST验证
                                   # 3. 再降级到Backpack市场价估算
                                   # 
                                   # 建议：
                                   # - Lighter链上确认通常1-5秒，5秒超时已足够
                                   # - 如果经常看到"WebSocket超时"日志，增加此值
                                   # - 网络良好时可设置为3秒，提升速度
  
  # ============================================================================
  # 滑点配置（市价单专用）
  # ============================================================================
  slippage: 0.0002                # 🔥 基础滑点（万分之2 = 0.02%）
                                   # Lighter市价单实际上是带滑点保护的限价单
                                   # 此滑点用于计算市价单的保护价格
                                   # 
                                   # 示例（BTC = 100000）：
                                   # - 市价买单保护价：100000 * (1 + 0.0002) = 100020
                                   # - 市价卖单保护价：100000 * (1 - 0.0002) = 99980
                                   # 
                                   # 推荐值：
                                   # - 0.0001 : 万分之1（0.01%）- 非常激进，可能挂单
                                   # - 0.0002 : 万分之2（0.02%）- 默认值，适合大多数情况 ✅
                                   # - 0.0003 : 万分之3（0.03%）- 较保守
                                   # - 0.0005 : 万分之5（0.05%）- 保守
                                   # - 0.001  : 千分之1（0.1%） - 非常保守
                                   # 
                                   # ⚠️ 注意：
                                   # - 滑点太小：市价单可能变成挂单，无法立即成交
                                   # - 滑点太大：成交价格可能不理想，增加成本
                                   # - 如果频繁出现挂单失败，程序会自动提高滑点重试
                                   # 
                                   # 🔥 自动重试机制：
                                   # - 第1次：使用配置的基础滑点（如0.02%）
                                   # - 第2次：滑点×10 = 0.2%
                                   # - 第3次：滑点×100 = 2%
                                   # - 如果3次都失败，本轮交易标记为失败
  
  # ============================================================================
  # 价格稳定检测参数（在Backpack上监控）
  # ============================================================================
  stability_check_duration: 3      # 价格稳定检测时长（秒）
                                   # Backpack价格必须稳定N秒才触发Lighter交易
  price_tolerance: 0             # 价格波动容忍度
                                   # 0表示完全不变，0.1表示允许0.1美元波动
  check_interval: 0.1              # 价格检查间隔（秒）
  
  # ============================================================================
  # 订单簿条件检测（在Backpack上监控）
  # ============================================================================
  
  # 🔥 买卖单数量对比反转检测
  check_orderbook_reversal: true   # 是否检测Backpack买卖单数量对比反转（推荐启用）
                                   # - false : 仅检测价格稳定
                                   # - true  : 同时检测价格和买卖单数量对比（推荐）
                                   # 
                                   # 启用后：
                                   # - 监控Backpack买卖单数量对比关系（谁多谁少）
                                   # - 如果发生反转则重新计时
                                   # 
                                   # 示例：
                                   # 开始计时：买1数量(100) > 卖1数量(50) → "买单多"
                                   # 监控中：  买1数量(40) < 卖1数量(80) → "卖单多"，反转了！重置计时
                                   # 
                                   # 作用：确保在价格稳定期间，订单簿结构也保持稳定
  
  orderbook_reversal_trigger: 1    # 订单簿反转多少次后重置倒计时（默认3次）
                                   # - 1     : 反转1次就重置（严格，敏感）
                                   # - 3     : 反转3次才重置（推荐，平衡）
                                   # - 5     : 反转5次才重置（宽松）
                                   # 
                                   # 作用：避免因订单簿小幅波动而频繁重置倒计时
                                   # 只有当反转次数达到此阈值时才重置价格稳定检查
  
  # 🔥 买卖单数量比例检查
  orderbook_quantity_ratio: 300    # Backpack买卖单数量比例阈值（百分比）
                                   # - 0     : 不启用
                                   # - 150   : 要求1.5倍差距（推荐，平衡）
                                   # - 200   : 要求2倍差距（中等）
                                   # - 300   : 要求3倍差距（严格）
                                   # - 400   : 要求4倍差距（极严格）
                                   # 
                                   # 计算方式：
                                   # 比例 = max(买1数量, 卖1数量) / min(买1数量, 卖1数量) × 100
                                   # 
                                   # 作用：确保Backpack订单簿有明显偏向才开仓
                                   # - 比例不满足要求：重置倒计时，继续等待
                                   # - 比例满足要求：继续验证其他条件
                                   # 
                                   # 示例：
                                   # 买1: 2.0, 卖1: 1.0 → 比例 = 2.0/1.0 × 100 = 200%
                                   # 买1: 3.0, 卖1: 1.0 → 比例 = 3.0/1.0 × 100 = 300%
  
  # 🔥 最小数量检查（仅市价模式）
  orderbook_min_quantity: 7      # Backpack订单簿最小数量要求
                                   # - 0     : 不启用
                                   # - 0.001 : 数量多的一方必须 >= 0.001（宽松）
                                   # - 0.01  : 数量多的一方必须 >= 0.01（中等）
                                   # - 0.1   : 数量多的一方必须 >= 0.1（推荐）
                                   # 
                                   # 作用：确保Backpack有足够订单簿深度
                                   # - 数量不足：不重置倒计时，继续等待
                                   # - 数量充足：继续验证，准备开仓
                                   # 
                                   # 示例：
                                   # 要求: 0.01, 买1: 0.02, 卖1: 0.005 → 最大0.02 >= 0.01，满足
                                   # 要求: 0.01, 买1: 0.005, 卖1: 0.008 → 最大0.008 < 0.01，不满足
  
  # ============================================================================
  # 订单簿获取方式（仅Backpack）
  # ============================================================================
  orderbook_method: "rest"         # Backpack订单簿获取方式
                                   # - "rest"      : REST API 轮询（稳定）
                                   # - "websocket" : WebSocket 实时订阅（推荐）
  
  # 🔥 注意：fill_price_method 不适用于Lighter市价模式
  # 市价单立即成交，无需监控成交价格
  fill_price_method: "rest"        # 保留字段（Lighter市价模式不使用）
  
  # ============================================================================
  # 交易方向策略
  # ============================================================================
  direction_strategy: "alternate"  # 交易方向选择策略
                                   # - "random"    : 随机选择买入/卖出
                                   # - "alternate" : 交替买入/卖出（推荐）
  
  reverse_trading: false           # 🔥 反向交易模式（默认false）
                                   # - false : 正常模式（多单=买入开仓/卖出平仓，空单=卖出开仓/买入平仓）
                                   # - true  : 反向模式（多单=卖出开仓/买入平仓，空单=买入开仓/卖出平仓）
                                   # 
                                   # 功能说明：
                                   # 启用后，所有开仓和平仓方向完全反转
                                   # 原本应该买入的时候会卖出，原本应该卖出的时候会买入
                                   # 
                                   # 使用场景：
                                   # 1. 看空市场时，希望做空为主
                                   # 2. 测试反向策略的效果
                                   # 3. 对冲其他持仓
                                   # 
                                   # ⚠️ 注意：
                                   # - 其他所有判断条件（价格稳定、数量比例等）完全不变
                                   # - 仅开仓和平仓的方向反转
                                   # - 数量、时间等参数完全不变
  
  # ============================================================================
  # 风控参数
  # ============================================================================
  max_cycles: 0                    # 最大交易轮次（0表示无限）
  max_position: 0.01               # 最大持仓限制（BTC）
  max_slippage: 0.005              # 最大滑点容忍度（0.5%）
  order_timeout: 60                # 订单超时时间（秒）
  max_consecutive_fails: 3         # 最大连续失败次数后触发等待
  consecutive_fail_wait_minutes: 15  # 连续失败达到阈值后等待时间（分钟）
                                   # 0表示达到失败次数后直接停止
                                   # 15表示等待15分钟后重置失败计数并继续交易
  min_balance: 50                  # Lighter最小余额阈值（USDC）
                                   # 低于此值停止交易
                                   # 建议：每次交易金额 × 10
  
  # ============================================================================
  # 执行控制
  # ============================================================================
  cycle_interval: 10                # 每轮完成后等待时间（秒）
                                   # 建议：1-5秒，避免过于频繁
  emergency_stop: false            # 紧急停止开关
  auto_restart_on_error: false     # 错误后自动重启
  
  # ============================================================================
  # 日志配置
  # ============================================================================
  logging:
    enabled: true
    log_to_file: true              # 日志写入文件
    log_to_console: false          # 不输出到控制台（保护终端UI）
    log_level: "INFO"              # 日志级别
    log_dir: "logs"                # 日志目录
    log_file: "lighter_hyperliquid_volume_maker.log"  # 日志文件名（Hyperliquid信号源）
    
    # 日志轮转配置
    rotation:
      max_bytes: 2097152           # 单个日志文件最大大小（2MB）
      backup_count: 10             # 最多保留10个日志文件
      encoding: "utf-8"
  
  # ============================================================================
  # 统计配置
  # ============================================================================
  statistics:
    enabled: true
    track_total_volume: true       # 跟踪总交易量
    track_success_rate: true       # 跟踪成功率
    track_pnl: true                # 跟踪盈亏
    save_interval: 60              # 统计数据保存间隔（秒）
  
  # ============================================================================
  # 终端UI配置
  # ============================================================================
  ui:
    enabled: true
    refresh_rate: 1                # 刷新频率（次/秒）
    show_orderbook: true           # 显示Backpack订单簿
    show_recent_trades: true       # 显示最近成交
    recent_trades_limit: 10        # 显示最近N笔成交
  
  # ============================================================================
  # 高级配置
  # ============================================================================
  advanced:
    use_post_only: false           # 市价模式不适用
    cancel_on_timeout: true        # 超时后取消订单
    retry_on_rate_limit: true      # 触发限频后重试
    rate_limit_cooldown: 20         # 限频冷却时间（秒）
  
  # ============================================================================
  # 🔥 Lighter特殊说明
  # ============================================================================
  # 
  # 1. 价格精度：
  #    - Lighter使用动态价格精度（10^price_decimals）
  #    - BTC: 1位小数，乘数10
  #    - 适配器会自动处理
  # 
  # 2. Market ID：
  #    - Lighter的market_id从0开始
  #    - BTC: market_id=1
  #    - ETH: market_id=0
  # 
  # 3. 最小订单量：
  #    - BTC: 0.0002 (约$23)
  #    - 建议: 0.0005-0.001
  # 
  # 4. 手续费：
  #    - Taker费率: 0%（目前）
  #    - 但市价单有滑点成本
  # 
  # 5. 资金要求：
  #    - 建议最少: $200 USDC
  #    - 推荐: $500-1000 USDC
  # 
  # ==============================================================================

